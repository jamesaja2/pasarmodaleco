generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  PARTICIPANT
}

enum TransactionType {
  BUY
  SELL
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

model User {
  id              String                   @id @default(uuid())
  username        String                   @unique
  passwordHash    String
  role            UserRole                 @default(PARTICIPANT)
  isSuperAdmin    Boolean                  @default(false)
  hasLoggedIn     Boolean                  @default(false)
  teamName        String?
  schoolOrigin    String?
  broker          Broker?                  @relation(fields: [brokerId], references: [id])
  brokerId        String?
  startingBalance Decimal                  @db.Decimal(20, 2)
  currentBalance  Decimal                  @db.Decimal(20, 2)
  isActive        Boolean                  @default(true)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  lastLogin       DateTime?
  transactions    Transaction[]
  portfolio       PortfolioHolding[]
  newsPurchases   UserNewsPurchase[]
  interestPayments InterestPayment[]
  credential      ParticipantCredential?
}

model Broker {
  id            String        @id @default(uuid())
  brokerCode    String        @unique
  brokerName    String
  feePercentage Decimal       @db.Decimal(10, 4)
  interestRate  Decimal       @default(0) @db.Decimal(10, 4)
  description   String?
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  users         User[]
  transactions  Transaction[]
  interestPayments InterestPayment[]
}

model Company {
  id                String        @id @default(uuid())
  stockCode         String        @unique
  companyName       String
  sector            String
  description       String?
  location          String?
  logoUrl           String?
  sellingPrice      Decimal?      @db.Decimal(20, 2)  // Nilai Jual
  sharesOutstanding BigInt?       // Jumlah saham beredar
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  prices            StockPrice[]
  reports           FinancialReport[]
  news              News[]
  portfolio         PortfolioHolding[]
  transactions      Transaction[]
}

model StockPrice {
  id        String   @id @default(uuid())
  company   Company  @relation(fields: [companyId], references: [id])
  companyId String
  dayNumber Int
  price     Decimal  @db.Decimal(20, 2)
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([companyId, dayNumber])
  @@index([companyId, dayNumber])
}

model FinancialReport {
  id            String   @id @default(uuid())
  company       Company  @relation(fields: [companyId], references: [id])
  companyId     String
  dayNumber     Int
  reportContent String
  pdfUrl        String?
  isAvailable   Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([companyId, dayNumber])
}

model News {
  id          String    @id @default(uuid())
  title       String
  content     String
  dayNumber   Int
  isPaid      Boolean   @default(false)
  price       Decimal?  @db.Decimal(20, 2)
  publishedAt DateTime  @default(now())
  company     Company?  @relation(fields: [companyId], references: [id])
  companyId   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  purchases   UserNewsPurchase[]

  @@index([dayNumber])
  @@index([isPaid])
}

model Transaction {
  id             String            @id @default(uuid())
  user           User              @relation(fields: [userId], references: [id])
  userId         String
  broker         Broker            @relation(fields: [brokerId], references: [id])
  brokerId       String
  company        Company           @relation(fields: [companyId], references: [id])
  companyId      String
  dayNumber      Int
  transactionType TransactionType
  quantity       Int
  pricePerShare  Decimal           @db.Decimal(20, 2)
  totalAmount    Decimal           @db.Decimal(20, 2)
  balanceBefore  Decimal           @db.Decimal(20, 2)
  balanceAfter   Decimal           @db.Decimal(20, 2)
  brokerFee      Decimal           @db.Decimal(20, 2)
  timestamp      DateTime          @default(now())
  status         TransactionStatus @default(COMPLETED)
  createdAt      DateTime          @default(now())

  @@index([userId, dayNumber])
  @@index([timestamp])
}

model PortfolioHolding {
  id              String   @id @default(uuid())
  user            User     @relation(fields: [userId], references: [id])
  userId          String
  company         Company  @relation(fields: [companyId], references: [id])
  companyId       String
  quantity        Int
  averageBuyPrice Decimal  @db.Decimal(20, 2)
  lastUpdated     DateTime @default(now())

  @@unique([userId, companyId])
}

model DayControl {
  id                  String   @id @default(uuid())
  currentDay          Int      @default(0)
  totalDays           Int      @default(15)
  isSimulationActive  Boolean  @default(false)
  isPaused            Boolean  @default(false)
  pausedAt            DateTime?
  remainingMs         Int?     // Remaining milliseconds when paused
  simulationStartDate DateTime?
  lastDayChange       DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Setting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

model UserNewsPurchase {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  news        News     @relation(fields: [newsId], references: [id])
  newsId      String
  pricePaid   Decimal  @db.Decimal(20, 2)
  purchasedAt DateTime @default(now())

  @@unique([userId, newsId])
}

model Notification {
  id        String   @id @default(uuid())
  type      String
  title     String
  message   String
  createdAt DateTime @default(now())
}

model InterestPayment {
  id              String   @id @default(uuid())
  user            User     @relation(fields: [userId], references: [id])
  userId          String
  broker          Broker   @relation(fields: [brokerId], references: [id])
  brokerId        String
  dayNumber       Int
  portfolioValue  Decimal  @db.Decimal(20, 2)
  interestRate    Decimal  @db.Decimal(10, 4)
  interestAmount  Decimal  @db.Decimal(20, 2)
  balanceBefore   Decimal  @db.Decimal(20, 2)
  balanceAfter    Decimal  @db.Decimal(20, 2)
  createdAt       DateTime @default(now())

  @@index([userId, dayNumber])
}

model ParticipantCredential {
  id              String   @id @default(uuid())
  user            User     @relation(fields: [userId], references: [id])
  userId          String   @unique
  displayPassword String
  lastResetAt     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
